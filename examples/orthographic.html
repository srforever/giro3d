<html>
    <head>
        <title>Itowns - Orthographic Camera Example</title>

        <meta charset="UTF-8">
        <link rel="stylesheet" type="text/css" href="css/example.css">
        <link rel="stylesheet" type="text/css" href="css/loading_screen.css">

        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div id="viewerDiv">
        </div>
        <script src="../dist/itowns.js"></script>
        <script src="js/loading_screen.js"></script>
        <script type="text/javascript">

            /* global itowns, renderer */
            // # Orthographic viewer
            // Define geographic extent: CRS, min/max X, min/max Y
            var extent = new itowns.Extent(
                'EPSG:3857',
                -20037508.342789244, 20037508.342789244,
                -20037508.342789244, 20037508.342789244);

            // `viewerDiv` will contain iTowns' rendering area (`<canvas>`)
            var viewerDiv = document.getElementById('viewerDiv');

            let center = { x: 328745, y: 5904608 };
            let halfHeight = (6800000 - 5000000) / 2;
            let camera = new itowns.THREE.OrthographicCamera(
                    // left and right determined empirically
                    -628337.4524312895,
                    2111620.264270613,
                    center.y + halfHeight,
                    center.y - halfHeight,
                    0,
                    1000);

            // Instanciate PlanarView
            var view = new itowns.PlanarView(
                    viewerDiv, extent, { maxSubdivisionLevel: 10, camera: camera });

            var dragStartPosition;
            var dragCameraStart;

            // By default itowns' tiles geometry have a "skirt" (ie they have a height),
            // but in case of orthographic we don't need this feature, so disable it
            view.tileLayer.disableSkirt = true;

            // Add an TMS imagery layer
            var stamenSource = new itowns.olsource.Stamen({ layer: 'watercolor', wrapX: false });
            // Add a base layer
            view.addLayer({
                id: 'osm',
                type: 'color',
                protocol: 'oltile',
                source: stamenSource,
            }).catch(e => console.error(e));

            var onMouseWheel = function onMouseWheel(event) {
                var change = 1 - (Math.sign(event.wheelDelta || -event.detail) * 0.1);

                var halfNewWidth = (view.camera.camera3D.right - view.camera.camera3D.left) * change * 0.5;
                var halfNewHeight = (view.camera.camera3D.top - view.camera.camera3D.bottom) * change * 0.5;
                var cx = (view.camera.camera3D.right + view.camera.camera3D.left) * 0.5;
                var cy = (view.camera.camera3D.top + view.camera.camera3D.bottom) * 0.5;

                view.camera.camera3D.left = cx - halfNewWidth;
                view.camera.camera3D.right = cx + halfNewWidth;
                view.camera.camera3D.top = cy + halfNewHeight;
                view.camera.camera3D.bottom = cy - halfNewHeight;

                view.notifyChange(view.camera.camera3D, true);
            };

            viewerDiv.addEventListener('DOMMouseScroll', onMouseWheel);
            viewerDiv.addEventListener('mousewheel', onMouseWheel);

            viewerDiv.addEventListener('mousedown', function mouseDown(event) {
                dragStartPosition = view.eventToViewCoords(event).clone();
                dragCameraStart = {
                    left: view.camera.camera3D.left,
                    right: view.camera.camera3D.right,
                    top: view.camera.camera3D.top,
                    bottom: view.camera.camera3D.bottom,
                };
            });
            const infoDiv = document.getElementById('info')
            viewerDiv.addEventListener('mousemove', function mouseMove(event) {
                var width;
                var deltaX;
                var deltaY;
                var newpos;
                if (dragStartPosition) {
                    newpos = view.eventToViewCoords(event);
                    width = view.camera.camera3D.right - view.camera.camera3D.left;
                    deltaX = width * (newpos.x - dragStartPosition.x) / -viewerDiv.clientWidth;
                    deltaY = width * (newpos.y - dragStartPosition.y) / viewerDiv.clientHeight;

                    view.camera.camera3D.left = dragCameraStart.left + deltaX;
                    view.camera.camera3D.right = dragCameraStart.right + deltaX;
                    view.camera.camera3D.top = dragCameraStart.top + deltaY;
                    view.camera.camera3D.bottom = dragCameraStart.bottom + deltaY;
                    view.notifyChange(view.camera.camera3D, true);
                }
            });
            viewerDiv.addEventListener('mouseup', function mouseUp() {
                dragStartPosition = undefined;
            });
        </script>
    </body>
</html>
